<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Multi-Form Survey Builder with Groups</title>
<style>
body { display:flex; height:100vh; margin:0; font-family:sans-serif; }
#sidebar { width:200px; background:#f0f0f0; padding:10px; box-sizing:border-box; display:flex; flex-direction:column; align-items:center; }
#addForm, #addGroup, #toggleEdit { width:100%; padding:5px 0; border-radius:8px; border:1px solid #888; background-color:#eee; cursor:pointer; margin-bottom:5px; text-align:center; transition:0.2s; }
#addForm:hover, #addGroup:hover, #toggleEdit:hover { background:#ddd; border-color:#555; }
#tabs { margin-top:10px; width:100%; flex:1; overflow-y:auto; }
.tab { padding:3px 5px; cursor:pointer; margin-bottom:2px; background:#ddd; font-size:12px; text-align:center; border-radius:3px; transition:0.2s; }
.tab.active { background:#bbb; }
.tab:hover { background-color:#ccc; }
#forms { flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; }
.field-group { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; border:1px dashed #aaa; padding:5px; position:relative; }
.field-group.row { flex-direction:row; }
.field-group.column { flex-direction:column; }
.field { border:1px solid #ccc; padding:5px; display:flex; flex-direction:column; min-width:150px; cursor:grab; }
#fieldsContainer input, #fieldsContainer select, #fieldsContainer button { margin-top:3px; }
#contextMenu { position:absolute; background:#fff; border:1px solid #aaa; box-shadow:2px 2px 4px rgba(0,0,0,0.2); display:none; z-index:1000; font-size:12px; min-width:100px; }
#contextMenu div { padding:3px 8px; cursor:pointer; }
#contextMenu div:hover { background:#eee; }
.deleteGroupBtn { position:absolute; top:5px; right:5px; font-size:10px; }
.addFieldBtn { margin-top:5px; }
</style>
</head>
<body>
<div id="sidebar">
  <button id="addForm">+ Add Form</button>
  <div id="tabs"></div>
</div>
<div id="forms">
  <div id="fieldsContainer"></div>
  <button id="addGroup">+ Add Group</button>
  <button id="toggleEdit">Switch to View</button>
</div>
<div id="contextMenu">
  <div id="menuDelete">Удалить</div>
  <div id="menuDuplicate">Дублировать</div>
  <div id="menuRename">Переименовать</div>
</div>

<script>
const tabsEl=document.getElementById('tabs');
const addBtn=document.getElementById('addForm');
const fieldsContainer=document.getElementById('fieldsContainer');
const addGroupBtn=document.getElementById('addGroup');
const toggleBtn=document.getElementById('toggleEdit');
const contextMenu=document.getElementById('contextMenu');

let forms=window.storage?.load('forms')||[];
let activeIndex=0;
let contextTabIndex=null;
let editMode=true;

// Tabs
function renderTabs(){
  tabsEl.innerHTML='';
  forms.forEach((f,i)=>{
    const tab=document.createElement('div');
    tab.className='tab'+(i===activeIndex?' active':'');
    tab.innerText=f.title||'Untitled';
    tab.title=f.title;
    tab.onclick=()=>switchForm(i);
    tab.oncontextmenu=(e)=>{ e.preventDefault(); showContextMenu(e.pageX,e.pageY,i); };
    tabsEl.appendChild(tab);
  });
}

function saveForms(){ if(window.storage) window.storage.save('forms',forms); }
function saveCurrentForm(){ if(forms[activeIndex]) saveForms(); }
function switchForm(index){ saveCurrentForm(); activeIndex=index; renderTabs(); renderFormFields(); }
function addForm(){ saveCurrentForm(); forms.push({ title:'New Form', groups:[] }); activeIndex=forms.length-1; renderTabs(); renderFormFields(); saveForms(); }
function deleteForm(index){ forms.splice(index,1); if(activeIndex>=forms.length) activeIndex=forms.length-1; renderTabs(); renderFormFields(); saveForms(); }

// Context Menu
function showContextMenu(x,y,index){ contextTabIndex=index; contextMenu.style.left=x+'px'; contextMenu.style.top=y+'px'; contextMenu.style.display='block'; }
document.addEventListener('click',()=>{ contextMenu.style.display='none'; });
document.getElementById('menuDelete').onclick=()=>{ if(contextTabIndex!==null){ if(confirm("Вы уверены, что хотите удалить эту форму?")) deleteForm(contextTabIndex); } contextMenu.style.display='none'; }
document.getElementById('menuDuplicate').onclick=()=>{ if(contextTabIndex!==null){ const original=forms[contextTabIndex]; const copy=JSON.parse(JSON.stringify(original)); copy.title+=' Copy'; forms.splice(contextTabIndex+1,0,copy); activeIndex=contextTabIndex+1; saveForms(); renderTabs(); renderFormFields(); } contextMenu.style.display='none'; }
document.getElementById('menuRename').onclick = () => {
  if (contextTabIndex !== null) {
    const tabEl = tabsEl.children[contextTabIndex];
    const oldTitle = forms[contextTabIndex].title;

    const input = document.createElement('input');
    input.type = 'text';
    input.value = oldTitle;
    input.maxLength = 50;
    input.style.width = '90%';
    input.style.fontSize = '12px';
    input.style.boxSizing = 'border-box';

    // Очищаем содержимое и вставляем input
    tabEl.innerHTML = '';
    tabEl.appendChild(input);
    input.focus();
    input.select();

    const saveTitle = () => {
      forms[contextTabIndex].title = input.value.trim() || 'Untitled';
      saveForms();
      renderTabs();
    };

    // Сохраняем при уходе фокуса или Enter
    input.addEventListener('blur', saveTitle);
    input.addEventListener('keydown', e => { if (e.key === 'Enter') input.blur(); });
  }
  contextMenu.style.display = 'none';
};

// Toggle Edit/View
toggleBtn.onclick=()=>{ editMode=!editMode; toggleBtn.textContent=editMode?'Switch to View':'Switch to Edit'; renderFormFields(); }

// Render Fields
function renderFormFields(){
  const form=forms[activeIndex]; if(!form.groups) form.groups=[];
  fieldsContainer.innerHTML='';
  addGroupBtn.style.display=editMode?'block':'none';
  toggleBtn.style.display=editMode?'block':'block';

  form.groups.forEach((group,gIdx)=>{
    const groupEl=document.createElement('div');
    groupEl.className='field-group '+(group.layout||'column');
    groupEl.dataset.groupIndex=gIdx;

    if(editMode){
      const layoutSelect=document.createElement('select');
      ['row','column'].forEach(l=>{ const opt=document.createElement('option'); opt.value=l; opt.textContent=l; if(l===group.layout) opt.selected=true; layoutSelect.appendChild(opt); });
      layoutSelect.onchange=()=>{ group.layout=layoutSelect.value; saveForms(); renderFormFields(); };
      groupEl.appendChild(layoutSelect);

      const delGroupBtn=document.createElement('button'); delGroupBtn.textContent='Delete Group'; delGroupBtn.className='deleteGroupBtn';
      delGroupBtn.onclick=()=>{ form.groups.splice(gIdx,1); saveForms(); renderFormFields(); };
      groupEl.appendChild(delGroupBtn);

      groupEl.draggable=true;
      groupEl.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain','group-'+gIdx); });
      groupEl.addEventListener('dragover', e=>{ e.preventDefault(); groupEl.style.border='2px dashed #888'; });
      groupEl.addEventListener('dragleave', e=>{ groupEl.style.border='1px dashed #aaa'; });
      groupEl.addEventListener('drop', e=>{
        e.preventDefault(); groupEl.style.border='1px dashed #aaa';
        const data=e.dataTransfer.getData('text/plain'); if(data.startsWith('group-')){
          const fromIdx=parseInt(data.split('-')[1]); if(fromIdx===gIdx) return;
          const moved=form.groups.splice(fromIdx,1)[0]; form.groups.splice(gIdx,0,moved); saveForms(); renderFormFields();
        }
      });
    }

    // Fields inside group
    group.fields.forEach((field,idx)=>{
      const fieldEl=document.createElement('div'); fieldEl.className='field'; fieldEl.dataset.index=idx;

      if(editMode){
        const idInput=document.createElement('input'); idInput.type='text'; idInput.value=field.id||`field_${Date.now()}`; field.id=idInput.value; idInput.placeholder='Field ID';
        idInput.oninput=()=>{ field.id=idInput.value; saveForms(); }; fieldEl.appendChild(idInput);
      }

      if(editMode){
        const nameInput=document.createElement('input'); nameInput.type='text'; nameInput.value=field.placeholder||''; nameInput.placeholder='Field Name';
        nameInput.oninput=e=>{ field.placeholder=e.target.value; saveForms(); };
        fieldEl.appendChild(nameInput);
      } else { const label=document.createElement('label'); label.textContent=field.placeholder||'Untitled'; fieldEl.appendChild(label); }

      if(editMode){
        const typeSelect=document.createElement('select'); ['plain text','date','list'].forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; if(t===field.type) opt.selected=true; typeSelect.appendChild(opt); });
        typeSelect.onchange=()=>{ field.type=typeSelect.value; if(field.type==='list'&&!field.options) field.options=[]; saveForms(); renderFormFields(); };
        fieldEl.appendChild(typeSelect);
      }

      // Default / Value
      if(field.type==='list'){
        if(editMode){
          const optionsContainer=document.createElement('div'); optionsContainer.style.marginTop='5px';
          field.options.forEach((opt,optIdx)=>{
            const optDiv=document.createElement('div'); optDiv.style.display='flex'; optDiv.style.marginBottom='2px';
            const optInput=document.createElement('input'); optInput.type='text'; optInput.value=opt; optInput.placeholder='Option'; optInput.style.flex='1';
            optInput.oninput=()=>{ field.options[optIdx]=optInput.value; saveForms(); };
            const delOptBtn=document.createElement('button'); delOptBtn.textContent='x'; delOptBtn.onclick=()=>{ field.options.splice(optIdx,1); saveForms(); renderFormFields(); };
            optDiv.appendChild(optInput); optDiv.appendChild(delOptBtn); optionsContainer.appendChild(optDiv);
          });
          const addOptionBtn=document.createElement('button'); addOptionBtn.textContent='+ Add Option'; addOptionBtn.onclick=()=>{ field.options.push(''); saveForms(); renderFormFields(); };
          optionsContainer.appendChild(addOptionBtn);
          fieldEl.appendChild(optionsContainer);
        } else {
          const selectEl=document.createElement('select'); field.options.forEach(o=>{ const opt=document.createElement('option'); opt.value=o; opt.textContent=o; selectEl.appendChild(opt); });
          fieldEl.appendChild(selectEl);
        }
      } else {
        const valInput=document.createElement('input'); valInput.type=field.type==='date'?'date':'text'; valInput.value=field.default||''; valInput.placeholder='Default Value';
        valInput.oninput=()=>{ field.default=valInput.value; saveForms(); };
        fieldEl.appendChild(valInput);
      }

      if(editMode){
        const delBtn=document.createElement('button'); delBtn.textContent='Delete Field'; delBtn.onclick=()=>{ group.fields.splice(idx,1); saveForms(); renderFormFields(); }; fieldEl.appendChild(delBtn);

        fieldEl.draggable=true;
        fieldEl.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain','field-'+gIdx+'-'+idx); });
        fieldEl.addEventListener('dragover', e=>{ e.preventDefault(); fieldEl.style.border='2px dashed #888'; });
        fieldEl.addEventListener('dragleave', e=>{ fieldEl.style.border='1px solid #ccc'; });
        fieldEl.addEventListener('drop', e=>{
          e.preventDefault(); fieldEl.style.border='1px solid #ccc';
          const data=e.dataTransfer.getData('text/plain'); if(!data.startsWith('field-')) return;
          const [_,fromG,fromIdx]=data.split('-').map(Number); if(fromG===gIdx && fromIdx===idx) return;
          const moved=form.groups[fromG].fields.splice(fromIdx,1)[0]; form.groups[gIdx].fields.splice(idx,0,moved); saveForms(); renderFormFields();
        });
      }

      groupEl.appendChild(fieldEl);
    });

    if(editMode){
      const addFieldBtn=document.createElement('button'); addFieldBtn.textContent='+ Add Field'; addFieldBtn.className='addFieldBtn';
      addFieldBtn.onclick=()=>{ group.fields.push({ id:`field_${Date.now()}`, placeholder:'', type:'plain text', options:[], default:'' }); saveForms(); renderFormFields(); };
      groupEl.appendChild(addFieldBtn);
    }

    fieldsContainer.appendChild(groupEl);
  });
}

// Buttons
addBtn.onclick=addForm;
addGroupBtn.onclick=()=>{ const form=forms[activeIndex]; if(!form.groups) form.groups=[]; form.groups.push({ layout:'row', fields:[] }); saveForms(); renderFormFields(); };

// Init
if(forms.length===0) addForm(); else{ renderTabs(); renderFormFields(); }
</script>
</body>
</html>
