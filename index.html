<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Multi-Form Survey Builder</title>
<style>
body { display: flex; height: 100vh; margin: 0; font-family: sans-serif; }
#sidebar { width: 200px; background: #f0f0f0; padding: 10px; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; }
#addForm { width: 100%; padding: 5px 0; border-radius: 8px; border: 1px solid #888; background-color: #eee; cursor: pointer; margin-bottom: 5px; text-align: center; transition: background-color 0.2s; }
#addForm:hover { background-color: #ddd; border-color: #555; }
#tabs { margin-top: 10px; width: 100%; flex: 1; overflow-y: auto; }
.tab { padding: 3px 5px; cursor: pointer; margin-bottom: 2px; background: #ddd; font-size: 12px; text-align: center; border-radius: 3px; transition: background-color 0.2s; }
.tab.active { background: #bbb; }
.tab:hover { background-color: #ccc; }
#forms { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; }
#fieldsContainer .field { border: 1px solid #ccc; padding: 5px; margin-bottom: 5px; display: flex; flex-direction: column; cursor: grab; }
#fieldsContainer input, #fieldsContainer select, #fieldsContainer button { margin-top: 3px; }
#contextMenu { position: absolute; background: #fff; border: 1px solid #aaa; box-shadow: 2px 2px 4px rgba(0,0,0,0.2); display: none; z-index: 1000; font-size: 12px; min-width: 100px; }
#contextMenu div { padding: 3px 8px; cursor: pointer; }
#contextMenu div:hover { background: #eee; }
</style>
</head>
<body>
<div id="sidebar">
<button id="addForm">+ Add Form</button>
<div id="tabs"></div>
</div>

<div id="forms">
<div id="fieldsContainer"></div>
<button id="addField">+ Add Field</button>
</div>

<div id="contextMenu">
<div id="menuDelete">Удалить</div>
<div id="menuDuplicate">Дублировать</div>
<div id="menuRename">Переименовать</div>
</div>

<script>
const tabsEl = document.getElementById('tabs');
const addBtn = document.getElementById('addForm');
const fieldsContainer = document.getElementById('fieldsContainer');
const addFieldBtn = document.getElementById('addField');
const contextMenu = document.getElementById('contextMenu');

let forms = window.storage?.load('forms') || [];
let activeIndex = 0;
let contextTabIndex = null;
let editMode = true;

// ------------------ Tabs ------------------
function renderTabs() {
  tabsEl.innerHTML = '';
  forms.forEach((f, i) => {
    const tab = document.createElement('div');
    tab.className = 'tab' + (i === activeIndex ? ' active' : '');
    tab.innerText = f.title || 'Untitled';
    tab.title = f.title;
    tab.onclick = () => switchForm(i);
    tab.oncontextmenu = (e) => { e.preventDefault(); showContextMenu(e.pageX, e.pageY, i); };
    tabsEl.appendChild(tab);
  });
}

function saveForms() { if(window.storage) window.storage.save('forms', forms); }
function saveCurrentForm() { if(forms[activeIndex]) saveForms(); }
function switchForm(index) { saveCurrentForm(); activeIndex = index; renderTabs(); renderFormFields(); }
function addForm() { saveCurrentForm(); forms.push({ title: 'New Form', fields: [] }); activeIndex = forms.length - 1; renderTabs(); renderFormFields(); saveForms(); }
function deleteForm(index) { forms.splice(index,1); if(activeIndex>=forms.length) activeIndex=forms.length-1; renderTabs(); renderFormFields(); saveForms(); }

// ------------------ Context Menu ------------------
function showContextMenu(x, y, index) { contextTabIndex = index; contextMenu.style.left = x+'px'; contextMenu.style.top = y+'px'; contextMenu.style.display='block'; }
document.addEventListener('click', ()=>{contextMenu.style.display='none';});
document.getElementById('menuDelete').onclick = ()=>{ if(contextTabIndex!==null){if(confirm("Вы уверены, что хотите удалить эту форму?")) deleteForm(contextTabIndex);} contextMenu.style.display='none'; }
document.getElementById('menuDuplicate').onclick = ()=>{ if(contextTabIndex!==null){ const original=forms[contextTabIndex]; const copy=JSON.parse(JSON.stringify(original)); copy.title+=' Copy'; forms.splice(contextTabIndex+1,0,copy); activeIndex=contextTabIndex+1; saveForms(); renderTabs(); renderFormFields(); } contextMenu.style.display='none'; }
document.getElementById('menuRename').onclick = ()=>{ if(contextTabIndex!==null){ const tabEl=tabsEl.children[contextTabIndex]; const oldTitle=forms[contextTabIndex].title; const input=document.createElement('input'); input.type='text'; input.value=oldTitle; input.maxLength=50; input.style.width='90%'; input.style.fontSize='12px'; input.style.boxSizing='border-box'; tabEl.innerHTML=''; tabEl.appendChild(input); input.focus(); input.select(); const saveTitle=()=>{forms[contextTabIndex].title=input.value.trim()||'Untitled'; saveForms(); renderTabs();}; input.addEventListener('blur', saveTitle); input.addEventListener('keydown', (e)=>{if(e.key==='Enter') saveTitle();});} contextMenu.style.display='none'; }

// ------------------ Render Fields ------------------
function renderFormFields(){
  const form=forms[activeIndex]; if(!form.fields) form.fields=[];
  fieldsContainer.innerHTML='';

  form.fields.forEach((field, idx)=>{
    const fieldEl=document.createElement('div'); fieldEl.className='field'; fieldEl.dataset.index=field.index??idx;

    // context menu
    fieldEl.oncontextmenu = (e) => { e.preventDefault(); contextTabIndex = idx; contextMenu.style.left = e.pageX+'px'; contextMenu.style.top = e.pageY+'px'; contextMenu.style.display='block'; };

    // drag & drop
    if(editMode){
      fieldEl.draggable = true;
      fieldEl.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', idx); });
      fieldEl.addEventListener('dragover', e => { e.preventDefault(); fieldEl.style.border='2px dashed #888'; });
      fieldEl.addEventListener('dragleave', e => { fieldEl.style.border='1px solid #ccc'; });
      fieldEl.addEventListener('drop', e => {
        e.preventDefault(); fieldEl.style.border='1px solid #ccc';
        const fromIdx=parseInt(e.dataTransfer.getData('text/plain'));
        if(fromIdx===idx) return;
        const moved=form.fields.splice(fromIdx,1)[0];
        form.fields.splice(idx,0,moved);
        saveForms();
        renderFormFields();
      });
    }

    // Field ID
    if(editMode){
      const idInput = document.createElement('input');
      idInput.type='text';
      idInput.value=field.id??'';
      idInput.placeholder='Field ID';
      idInput.oninput=()=>{ field.id=idInput.value; saveForms(); };
      fieldEl.appendChild(idInput);
    }

    // Field Name
    if(editMode){
      const nameInput=document.createElement('input');
      nameInput.type='text';
      nameInput.value=field.placeholder||'';
      nameInput.placeholder='Field Name';
      nameInput.oninput=e=>{ field.placeholder=e.target.value; saveForms(); }; // без ререндеринга
      fieldEl.appendChild(nameInput);
    } else {
      const label=document.createElement('label');
      label.textContent=field.placeholder||'Untitled';
      label.style.fontWeight='bold';
      fieldEl.appendChild(label);
    }

    // Type selector
    if(editMode){
      const typeSelect=document.createElement('select');
      ['plain text','date','list'].forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; if(t===field.type) opt.selected=true; typeSelect.appendChild(opt); });
      typeSelect.onchange=()=>{ field.type=typeSelect.value; if(field.type==='list'&&!field.options) field.options=[]; saveForms(); renderFormFields(); };
      fieldEl.appendChild(typeSelect);
    }

    // Default / value input
    if(field.type==='list'){
      if(editMode){
        const optionsContainer=document.createElement('div'); optionsContainer.style.marginTop='5px';
        field.options.forEach((opt,optIdx)=>{
          const optDiv=document.createElement('div'); optDiv.style.display='flex'; optDiv.style.marginBottom='2px';
          const optInput=document.createElement('input'); optInput.type='text'; optInput.value=opt; optInput.placeholder='Option'; optInput.style.flex='1';
          optInput.oninput=()=>{ field.options[optIdx]=optInput.value; saveForms(); };
          const delOptBtn=document.createElement('button'); delOptBtn.textContent='x';
          delOptBtn.onclick=()=>{ field.options.splice(optIdx,1); saveForms(); renderFormFields(); };
          optDiv.appendChild(optInput); optDiv.appendChild(delOptBtn); optionsContainer.appendChild(optDiv);
        });
        // Add Option **под всеми опциями**
        const addOptBtn=document.createElement('button'); addOptBtn.textContent='+ Add Option';
        addOptBtn.onclick=()=>{ field.options.push(''); saveForms(); renderFormFields(); };
        optionsContainer.appendChild(addOptBtn);
        fieldEl.appendChild(optionsContainer);
      } else {
        const select=document.createElement('select');
        field.options.forEach(opt=>{ const optEl=document.createElement('option'); optEl.value=opt; optEl.textContent=opt; select.appendChild(optEl); });
        fieldEl.appendChild(select);
      }
    } else {
      const valueInput=document.createElement('input');
      valueInput.type=(field.type==='date')?'date':'text';
      valueInput.value=field.default||'';
      if(editMode) valueInput.placeholder='Default Value';
      if(editMode) valueInput.oninput=()=>{ field.default=valueInput.value; saveForms(); };
      fieldEl.appendChild(valueInput);
    }

    // Delete
    if(editMode){
      const delBtn=document.createElement('button'); delBtn.textContent='Delete Field'; delBtn.style.marginTop='5px';
      delBtn.onclick=()=>{ form.fields.splice(idx,1); saveForms(); renderFormFields(); };
      fieldEl.appendChild(delBtn);
    }

    fieldsContainer.appendChild(fieldEl);
  });

  // Toggle button
  let toggleBtn=document.getElementById('toggleEdit');
  if(!toggleBtn){ toggleBtn=document.createElement('button'); toggleBtn.id='toggleEdit'; toggleBtn.style.marginTop='10px'; toggleBtn.onclick=toggleEditMode; fieldsContainer.parentNode.appendChild(toggleBtn); }
  toggleBtn.textContent=editMode?'Save Form':'Edit Form';
  addFieldBtn.style.display=editMode?'block':'none';
}

function toggleEditMode(){ editMode=!editMode; renderFormFields(); }

function addField() {
  const form=forms[activeIndex];
  if(!form.fields) form.fields=[];
  const newIndex=form.fields.length>0?Math.max(...form.fields.map(f=>f.index??0))+1:0;
  form.fields.push({ index:newIndex, id:`field_${Date.now()}`, placeholder:'', type:'plain text', options:[] });
  saveForms();
  renderFormFields();
}

// Event Listeners
addBtn.onclick=addForm;
addFieldBtn.onclick=addField;

// Initial render
if(forms.length===0) addForm(); else { renderTabs(); renderFormFields(); }

</script>

</body>
</html>
