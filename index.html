<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Multi-Form App</title>
  <style>
    body { display: flex; height: 100vh; margin: 0; font-family: sans-serif; }

    /* Сайдбар */
    #sidebar {
      width: 200px;
      background: #f0f0f0;
      padding: 10px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Кнопка Add Form */
    #addForm {
      width: 100%;
      padding: 5px 0;
      border-radius: 8px;
      border: 1px solid #888;
      background-color: #eee;
      cursor: pointer;
      margin-bottom: 5px;
      transition: background-color 0.2s;
      text-align: center;
    }
    #addForm:hover {
      background-color: #ddd;
      border-color: #555;
    }

    /* Список вкладок */
    #tabs {
      margin-top: 10px;
      width: 100%;
      flex: 1;
      overflow-y: auto; /* прокрутка только вкладок */
    }
    .tab {
      padding: 3px 5px;
      cursor: pointer;
      margin-bottom: 2px;
      background: #ddd;
      font-size: 12px;
      text-align: center;
      border-radius: 3px;
      transition: background-color 0.2s;
    }
    .tab.active { background: #bbb; }
    .tab:hover { background-color: #ccc; }

    /* Основная форма */
    #forms {
      flex: 1;
      padding: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    #formTitle {
      width: 100%;
      margin-bottom: 5px;
    }
    #formData {
      flex: 1;
      width: 100%;
      resize: none;
    }
    input, textarea {
      box-sizing: border-box;
      padding: 5px;
      font-size: 14px;
    }

    #contextMenu {
    position: absolute;
    background: #fff;
    border: 1px solid #aaa;
    box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    display: none;
    z-index: 1000;
    font-size: 12px;   /* уменьшили шрифт */
    min-width: 100px;  /* ширина меню */
    }

    #contextMenu div {
    padding: 3px 8px;  /* меньше отступы */
    cursor: pointer;
    }

    #contextMenu div:hover {
    background: #eee;
    }

  </style>
</head>
<body>
  <div id="sidebar">
    <button id="addForm">+ Add Form</button>
    <div id="tabs"></div>
  </div>

  <div id="forms">
    <input type="text" id="formTitle" placeholder="Form title" maxlength="50">
    <textarea id="formData" rows="10" placeholder="Form data" maxlength="500"></textarea>
  </div>

  <!-- Контекстное меню -->
    <div id="contextMenu">
    <div id="menuDelete">Удалить</div>
    <div id="menuDuplicate">Дублировать</div>
    <div id="menuRename">Переименовать</div> <!-- новая кнопка -->
    </div>

  <script>
    const tabsEl = document.getElementById('tabs')
    const addBtn = document.getElementById('addForm')
    const titleInput = document.getElementById('formTitle')
    const dataInput = document.getElementById('formData')
    const contextMenu = document.getElementById('contextMenu')

    let forms = window.storage.load('forms') || []
    let activeIndex = 0
    let contextTabIndex = null

    function renderTabs() {
      tabsEl.innerHTML = ''
      forms.forEach((f, i) => {
        const tab = document.createElement('div')
        tab.className = 'tab' + (i === activeIndex ? ' active' : '')
        tab.innerText = f.title || 'Untitled'
        tab.title = f.title
        tab.onclick = () => switchForm(i)
        tab.oncontextmenu = (e) => {
          e.preventDefault()
          showContextMenu(e.pageX, e.pageY, i)
        }
        tabsEl.appendChild(tab)
      })
    }

    function saveForms() {
      window.storage.save('forms', forms)
    }

    function saveCurrentForm() {
      if (forms[activeIndex]) {
        forms[activeIndex].title = titleInput.value
        forms[activeIndex].data = dataInput.value
        saveForms()
      }
    }

    function loadForm() {
      if (forms[activeIndex]) {
        titleInput.value = forms[activeIndex].title
        dataInput.value = forms[activeIndex].data
      } else {
        titleInput.value = ''
        dataInput.value = ''
      }
    }

    function addForm() {
      saveCurrentForm()
      forms.push({ title: 'New Form', data: '' })
      activeIndex = forms.length - 1
      loadForm()
      renderTabs()
    }

    function deleteForm(index) {
      forms.splice(index, 1)
      if (activeIndex >= forms.length) activeIndex = forms.length - 1
      loadForm()
      renderTabs()
      saveForms()
    }

    function switchForm(index) {
      saveCurrentForm()
      activeIndex = index
      loadForm()
      renderTabs()
    }

    function showContextMenu(x, y, index) {
      contextTabIndex = index
      contextMenu.style.left = x + 'px'
      contextMenu.style.top = y + 'px'
      contextMenu.style.display = 'block'
    }

    // скрыть меню при клике вне
    document.addEventListener('click', () => {
      contextMenu.style.display = 'none'
    })

    document.getElementById('menuDelete').onclick = () => {
    if (contextTabIndex !== null) {
        if (confirm("Вы уверены, что хотите удалить эту форму?")) {
        deleteForm(contextTabIndex)
        }
    }
    contextMenu.style.display = 'none'
    }

    document.getElementById('menuDuplicate').onclick = () => {
      if (contextTabIndex !== null) {
        const original = forms[contextTabIndex]
        forms.splice(contextTabIndex + 1, 0, {
          title: original.title + ' Copy',
          data: original.data
        })
        activeIndex = contextTabIndex + 1
        saveForms()
        loadForm()
        renderTabs()
      }
      contextMenu.style.display = 'none'
    }

  document.getElementById('menuRename').onclick = () => {
    if (contextTabIndex !== null) {
      const tabEl = tabsEl.children[contextTabIndex]
      const oldTitle = forms[contextTabIndex].title

      // Создаем input вместо текста вкладки
      const input = document.createElement('input')
      input.type = 'text'
      input.value = oldTitle
      input.maxLength = 20
      input.style.width = '90%'
      input.style.fontSize = '12px'
      input.style.boxSizing = 'border-box'

      // Заменяем текст вкладки на input
      tabEl.innerHTML = ''
      tabEl.appendChild(input)
      input.focus()
      input.select()

      // Сохраняем новое название при потере фокуса или Enter
      const saveTitle = () => {
        const newTitle = input.value.trim() || 'Untitled'
        forms[contextTabIndex].title = newTitle
        saveForms()
        renderTabs()
      }

      input.addEventListener('blur', saveTitle)
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          saveTitle()
        }
      })
    }
    contextMenu.style.display = 'none'
  }

    addBtn.onclick = addForm
    titleInput.oninput = saveCurrentForm
    dataInput.oninput = saveCurrentForm

    // начальная отрисовка
    if (forms.length === 0) addForm()
    else { loadForm(); renderTabs() }
  </script>
</body>
</html>
