<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>DocxGenerator</title>
  <style>
    body {
      display: flex;
      height: 100vh;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f7f8fa;
      color: #333;
      font-size: 12px;
      /* компактный базовый размер */
    }

    #sidebar {
      width: 180px;
      background: #e8ebf0;
      padding: 8px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      border-right: 1px solid #d0d4d9;
    }

    #tabs {
      margin-top: 8px;
      width: 100%;
      flex: 1;
      overflow-y: auto;
    }

    .tab {
      padding: 4px 6px;
      /* меньшие отступы */
      cursor: pointer;
      margin-bottom: 3px;
      background: #dde1e6;
      font-size: 11px;
      text-align: center;
      border-radius: 3px;
      transition: 0.15s;
      color: #333;
    }

    .tab.active {
      background: #cfd4da;
      font-weight: 500;
    }

    .tab:hover {
      background-color: #d3d8df;
    }

    #forms {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background-color: #fafbfc;
    }

    .field-group {
      border: 1px dashed #ccc;
      padding: 6px;
      margin-bottom: 8px;
      border-radius: 4px;
      background-color: #fff;
    }

    .field {
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 4px;
      display: flex;
      flex-direction: column;
      min-width: 140px;
      cursor: grab;
      background-color: #f9f9f9;
      transition: 0.15s;
      font-size: 12px;
    }

    .field:hover {
      border-color: #aaa;
      background-color: #f1f2f4;
    }

    #contextMenu {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 1000;
      font-size: 11px;
      min-width: 100px;
    }

    #contextMenu div {
      padding: 3px 6px;
      cursor: pointer;
    }

    #contextMenu div:hover {
      background: #f0f0f0;
    }

    input,
    select,
    textarea {
      border: 1px solid #bbb;
      border-radius: 3px;
      padding: 3px;
      font-size: 12px;
      width: 100%;
      box-sizing: border-box;
      background-color: #fafafa;
      color: #333;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #888;
      background-color: #fff;
    }

    button {
      font-family: inherit;
      border-radius: 4px;
      border: 1px solid #bbb;
      padding: 4px 0;
      font-size: 12px;
      cursor: pointer;
      text-align: center;
      transition: 0.15s;
    }

    /* Лёгкий цвет для кнопок */
    #addForm {
      background-color: #e3f2fd;
      color: #0d47a1;
      margin-bottom: 4px;
    }

    #addGroup {
      background-color: #e8f5e9;
      color: #2e7d32;
    }

    #toggleEdit {
      background-color: #fff3e0;
      color: #ef6c00;
    }

    #generateBtn {
      background-color: #f3e5f5;
      color: #6a1b9a;
    }

    #clearBtn {
      background-color: #ffebee;
      color: #c62828;
    }

    #addForm:hover {
      background-color: #bbdefb;
      border-color: #90caf9;
    }

    #addGroup:hover {
      background-color: #c8e6c9;
      border-color: #a5d6a7;
    }

    #toggleEdit:hover {
      background-color: #ffe0b2;
      border-color: #ffb74d;
    }

    #generateBtn:hover {
      background-color: #e1bee7;
      border-color: #ce93d8;
    }

    #clearBtn:hover {
      background-color: #ffcdd2;
      border-color: #ef9a9a;
    }
  </style>

</head>

<body>
  <div id="sidebar">
    <button id="addForm">+ Добавить форму</button>
    <div id="tabs"></div>
  </div>
  <div id="forms">
    <div id="fieldsContainer"></div>
    <button id="addGroup">+ Добавить группу</button>
    <button id="toggleEdit">Переключить в режим настройки</button>
  </div>
  <div id="contextMenu">
    <div id="menuDelete">Удалить</div>
    <div id="menuDuplicate">Дублировать</div>
    <div id="menuRename">Переименовать</div>
  </div>
  <div id="modal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
    <div style="background:#fff; padding:20px; border-radius:8px; min-width:300px;">
      <div id="modalText"></div>
      <div style="margin-top:10px; text-align:right;">
        <button id="modalCancel">Отменить</button>
        <button id="modalOk">Принять</button>
      </div>
    </div>
  </div>

  <script>
    function showConfirm(message, warningType = true) {
      return new Promise(resolve => {
        const modal = document.getElementById('modal');
        const modalText = document.getElementById('modalText');
        const okBtn = document.getElementById('modalOk');
        const cancelBtn = document.getElementById('modalCancel');

        modalText.innerText = message;
        modal.style.display = 'flex';

        // Скрываем или показываем кнопку Cancel
        cancelBtn.style.display = warningType ? 'none' : 'inline-block';

        const cleanup = () => {
          modal.style.display = 'none';
          okBtn.removeEventListener('click', onOk);
          cancelBtn.removeEventListener('click', onCancel);
        };

        const onOk = () => { cleanup(); resolve(true); };
        const onCancel = () => { cleanup(); resolve(false); };

        okBtn.addEventListener('click', onOk);
        if (!warningType) cancelBtn.addEventListener('click', onCancel);
      });
    }



    const tabsEl = document.getElementById('tabs');
    const addBtn = document.getElementById('addForm');
    const fieldsContainer = document.getElementById('fieldsContainer');
    const addGroupBtn = document.getElementById('addGroup');
    const toggleBtn = document.getElementById('toggleEdit');
    // Create Generate button
    const generateBtn = document.createElement('button');
    generateBtn.id = 'generateBtn';
    generateBtn.textContent = 'Сгенерировать';

    // Insert Generate before toggle
    toggleBtn.parentNode.insertBefore(generateBtn, toggleBtn);

    const clearBtn = document.createElement('button');
    clearBtn.id = 'clearBtn';
    clearBtn.textContent = 'Очистить форму';
    generateBtn.parentNode.insertBefore(clearBtn, generateBtn.nextSibling);

    clearBtn.onclick = async () => {
      const proceed = await showConfirm('Вы уверены, что хотите очистить эту форму?', false);
      if (!proceed) return;
      const form = forms[activeIndex];
      form.groups.forEach(group => {
        group.fields.forEach(field => {
          if (field.type === 'list') {
            // Сбрасываем выбранное значение списка
            field.value = field.options && field.options.length ? field.options[0] : '';
          } else {
            field.value = field.default || '';
            field.val = field.value;
          }
        });
      });
      saveForms();
      renderFormFields();
    };



    // Move toggle button to the right under Generate
    toggleBtn.style.width = '100%';
    toggleBtn.style.marginTop = '0';

    const contextMenu = document.getElementById('contextMenu');

    let forms = window.storage?.load('forms') || [];
    let activeIndex = 0;
    let contextTabIndex = null;
    let editMode = false;

    // Tabs
    function renderTabs() {
      tabsEl.innerHTML = '';
      forms.forEach((f, i) => {
        const tab = document.createElement('div');
        tab.className = 'tab' + (i === activeIndex ? ' active' : '');
        tab.innerText = f.title || 'Untitled';
        tab.title = f.title;
        tab.onclick = () => switchForm(i);
        tab.oncontextmenu = (e) => { e.preventDefault(); showContextMenu(e.pageX, e.pageY, i); };
        tabsEl.appendChild(tab);
      });
    }

    function saveForms() { if (window.storage) window.storage.save('forms', forms); }
    function saveCurrentForm() { if (forms[activeIndex]) saveForms(); }
    function switchForm(index) { saveCurrentForm(); activeIndex = index; renderTabs(); renderFormFields(); }
    function addForm() { saveCurrentForm(); forms.push({ title: 'Новая форма', groups: [] }); activeIndex = forms.length - 1; renderTabs(); renderFormFields(); saveForms(); }
    function deleteForm(index) { forms.splice(index, 1); if (activeIndex >= forms.length) activeIndex = forms.length - 1; renderTabs(); renderFormFields(); saveForms(); }

    // Context Menu
    function showContextMenu(x, y, index) { contextTabIndex = index; contextMenu.style.left = x + 'px'; contextMenu.style.top = y + 'px'; contextMenu.style.display = 'block'; }
    document.addEventListener('click', () => { contextMenu.style.display = 'none'; });
    document.getElementById('menuDelete').onclick = async () => {
      if (contextTabIndex !== null) {
        const proceed = await showConfirm('Вы уверены, что хотите удалить эту форму?', false);
        if (!proceed) return;
        deleteForm(contextTabIndex);
      } contextMenu.style.display = 'none';
    }
    document.getElementById('menuDuplicate').onclick = () => { if (contextTabIndex !== null) { const original = forms[contextTabIndex]; const copy = JSON.parse(JSON.stringify(original)); copy.title += ' Copy'; forms.splice(contextTabIndex + 1, 0, copy); activeIndex = contextTabIndex + 1; saveForms(); renderTabs(); renderFormFields(); } contextMenu.style.display = 'none'; }
    document.getElementById('menuRename').onclick = () => {
      if (contextTabIndex !== null) {
        const tabEl = tabsEl.children[contextTabIndex];
        const oldTitle = forms[contextTabIndex].title;

        const input = document.createElement('input');
        input.type = 'text';
        input.value = oldTitle;
        input.maxLength = 50;
        input.style.width = '90%';
        input.style.fontSize = '12px';
        input.style.boxSizing = 'border-box';

        // Очищаем содержимое и вставляем input
        tabEl.innerHTML = '';
        tabEl.appendChild(input);
        input.focus();
        input.select();

        const saveTitle = () => {
          forms[contextTabIndex].title = input.value.trim() || 'Untitled';
          saveForms();
          renderTabs();
        };

        // Сохраняем при уходе фокуса или Enter
        input.addEventListener('blur', saveTitle);
        input.addEventListener('keydown', e => { if (e.key === 'Enter') input.blur(); });
      }
      contextMenu.style.display = 'none';
    };

    // Toggle Edit/View
    toggleBtn.onclick = () => {
      editMode = !editMode;
      toggleBtn.textContent = editMode ? 'Перключить в режим работы' : 'Переключить в режим настройки';
      generateBtn.style.display = editMode ? 'none' : 'block';
      renderFormFields();
    };

    generateBtn.style.display = 'block'; // hidden by default

    function formatDateToDDMMYYYY(dateStr) {
      if (!dateStr) return '';
      const [year, month, day] = dateStr.split('-');
      return `${day}.${month}.${year}`;
    }

    function renderFormFields() {
      const form = forms[activeIndex];
      if (!form.groups) form.groups = [];
      fieldsContainer.innerHTML = '';
      addGroupBtn.style.display = editMode ? 'block' : 'none';
      clearBtn.style.display = editMode ? 'none' : 'block';


      // === File & Directory section (per form) ===
      const topControls = document.createElement('div');
      topControls.style.marginBottom = '10px';
      topControls.style.display = 'flex';
      topControls.style.flexDirection = 'column';
      topControls.style.gap = '5px';
      fieldsContainer.appendChild(topControls);

      if (editMode) {
        // --- Edit Mode ---
        // File input
        const fileLabel = document.createElement('label');
        fileLabel.textContent = 'Select Files: ';
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.multiple = true;
        fileInput.onchange = () => {
          form.files = Array.from(fileInput.files).map(f => f.name);
          saveForms();
        };
        fileLabel.appendChild(fileInput);
        topControls.appendChild(fileLabel);
      } else {
        // --- View Mode ---
        const filesEl = document.createElement('div');
        filesEl.textContent = 'Files: ' + (form.files?.length ? form.files.join(', ') : 'None');
        topControls.appendChild(filesEl);
      }

      // === Groups rendering continues here ===

      form.groups.forEach((group, gIdx) => {
        const groupEl = document.createElement('div');
        groupEl.className = 'field-group';
        groupEl.dataset.groupIndex = gIdx;

        // Заголовок группы
        const titleEl = document.createElement(editMode ? 'input' : 'div');
        if (editMode) {
          titleEl.type = 'text';
          titleEl.value = group.label || '';
          titleEl.placeholder = 'Заголовок группы';
          titleEl.style.width = '100%';
          titleEl.style.marginBottom = '5px';
          titleEl.style.boxSizing = 'border-box';
          titleEl.oninput = () => { group.label = titleEl.value; saveForms(); };
        } else {
          titleEl.textContent = group.label || '';
          titleEl.style.fontWeight = 'bold';
          titleEl.style.width = '100%';
          titleEl.style.marginBottom = '5px';
        }
        groupEl.appendChild(titleEl);

        // Контейнер для полей
        const groupContent = document.createElement('div');
        groupContent.style.display = 'flex';
        groupContent.style.flexDirection = group.layout || 'column';
        groupContent.style.flexWrap = 'wrap';
        groupContent.style.gap = '10px';
        groupContent.style.width = '100%'; // ключевой момент для column
        groupEl.appendChild(groupContent);


        if (editMode) {
          // Layout select
          const layoutSelect = document.createElement('select');
          ['row', 'column'].forEach(l => {
            const opt = document.createElement('option');
            opt.value = l;
            opt.textContent = l;
            if (l === group.layout) opt.selected = true;
            layoutSelect.appendChild(opt);
          });
          layoutSelect.onchange = () => { group.layout = layoutSelect.value; saveForms(); renderFormFields(); };
          groupEl.appendChild(layoutSelect);

          // Delete group
          const delGroupBtn = document.createElement('button');
          delGroupBtn.textContent = 'Удалить группу';
          delGroupBtn.className = 'deleteGroupBtn';
          delGroupBtn.onclick = () => { form.groups.splice(gIdx, 1); saveForms(); renderFormFields(); };
          groupEl.appendChild(delGroupBtn);

          // Drag & drop for group
          groupEl.draggable = true;
          groupEl.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', 'group-' + gIdx); });
          groupEl.addEventListener('dragover', e => { e.preventDefault(); groupEl.style.border = '2px dashed #888'; });
          groupEl.addEventListener('dragleave', e => { groupEl.style.border = '1px dashed #aaa'; });
          groupEl.addEventListener('drop', e => {
            e.preventDefault(); groupEl.style.border = '1px dashed #aaa';
            const data = e.dataTransfer.getData('text/plain');
            if (data.startsWith('group-')) {
              const fromIdx = parseInt(data.split('-')[1]);
              if (fromIdx === gIdx) return;
              const moved = form.groups.splice(fromIdx, 1)[0];
              form.groups.splice(gIdx, 0, moved);
              saveForms(); renderFormFields();
            }
          });
        }

        // Поля
        group.fields.forEach((field, idx) => {
          const fieldEl = document.createElement('div');
          fieldEl.className = 'field';
          fieldEl.dataset.index = idx;

          if (editMode) {
            const idInput = document.createElement('input');
            idInput.type = 'text';
            idInput.value = field.id || `field_${Date.now()}`;
            field.id = idInput.value;
            idInput.placeholder = 'ID поля';
            idInput.oninput = () => { field.id = idInput.value || `field_${Date.now()}`; saveForms(); };
            fieldEl.appendChild(idInput);
          }

          if (editMode) {
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.value = field.placeholder || '';
            nameInput.placeholder = 'Подсказка';
            nameInput.oninput = e => { field.placeholder = e.target.value; saveForms(); };
            fieldEl.appendChild(nameInput);
          } else {
            const label = document.createElement('label');
            label.textContent = field.placeholder || 'Без названия';
            fieldEl.appendChild(label);
          }

          if (editMode) {
            const typeSelect = document.createElement('select');
            ['plain text', 'date', 'list'].forEach(t => {
              const opt = document.createElement('option');
              opt.value = t; opt.textContent = t;
              if (t === field.type) opt.selected = true;
              typeSelect.appendChild(opt);
            });
            typeSelect.onchange = () => { field.type = typeSelect.value; if (field.type === 'list' && !field.options) field.options = []; saveForms(); renderFormFields(); };
            fieldEl.appendChild(typeSelect);
          }

          // Значения
          if (field.type === 'list') {
            if (editMode) {
              const optionsContainer = document.createElement('div');
              optionsContainer.style.marginTop = '5px';
              field.options.forEach((opt, optIdx) => {
                const optDiv = document.createElement('div');
                optDiv.style.display = 'flex'; optDiv.style.marginBottom = '2px';
                const optInput = document.createElement('input');
                optInput.type = 'text'; optInput.value = opt; optInput.placeholder = 'Вариант'; optInput.style.flex = '1';
                optInput.oninput = () => { field.options[optIdx] = optInput.value; saveForms(); };
                const delOptBtn = document.createElement('button'); delOptBtn.textContent = 'x'; delOptBtn.onclick = () => { field.options.splice(optIdx, 1); saveForms(); renderFormFields(); };
                optDiv.appendChild(optInput); optDiv.appendChild(delOptBtn); optionsContainer.appendChild(optDiv);
              });
              const addOptionBtn = document.createElement('button'); addOptionBtn.textContent = '+ Добавить вариант';
              addOptionBtn.onclick = () => { field.options.push(''); saveForms(); renderFormFields(); };
              optionsContainer.appendChild(addOptionBtn);
              fieldEl.appendChild(optionsContainer);
            } else {
              const selectEl = document.createElement('select');
              field.options.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o;
                opt.textContent = o;
                selectEl.appendChild(opt);
              });
              // Устанавливаем текущее значение
              selectEl.value = field.value || (field.options.length ? field.options[0] : '');
              field.value = selectEl.value;

              // Обновляем field.value при выборе
              selectEl.onchange = () => {
                field.value = selectEl.value;
                saveForms();
              };

              fieldEl.appendChild(selectEl);
            }
          } else {
            var valInput = NaN
            if (field.type === 'date') {
              valInput = document.createElement('input');
              valInput.type = 'date'
            }
            else {
              valInput = document.createElement('textarea');
              valInput.type = 'text'

            }
            valInput.value = field.default || '';
            field.val = valInput.value;
            valInput.placeholder = 'Значение по умолчанию';
            valInput.oninput = () => {
              if (editMode) {
                field.default = valInput.value;
              }
              if (field.type === 'date') {
                field.val = formatDateToDDMMYYYY(valInput.value);
              } else {
                field.val = valInput.value;
              }
              saveForms();
            };
            fieldEl.appendChild(valInput);
          }

          if (editMode) {
            const delBtn = document.createElement('button'); delBtn.textContent = 'Удалить поле';
            delBtn.onclick = () => { group.fields.splice(idx, 1); saveForms(); renderFormFields(); };
            fieldEl.appendChild(delBtn);

            // Drag & drop for field inside group
            fieldEl.draggable = true;
            fieldEl.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', 'field-' + gIdx + '-' + idx); });
            fieldEl.addEventListener('dragover', e => { e.preventDefault(); fieldEl.style.border = '2px dashed #888'; });
            fieldEl.addEventListener('dragleave', e => { fieldEl.style.border = '1px solid #ccc'; });
            fieldEl.addEventListener('drop', e => {
              e.preventDefault(); fieldEl.style.border = '1px solid #ccc';
              const data = e.dataTransfer.getData('text/plain');
              if (!data.startsWith('field-')) return;
              const [_, fromG, fromIdx] = data.split('-').map(Number);
              if (fromG === gIdx && fromIdx === idx) return;
              const moved = form.groups[fromG].fields.splice(fromIdx, 1)[0];
              form.groups[gIdx].fields.splice(idx, 0, moved);
              saveForms(); renderFormFields();
            });
          }

          groupContent.appendChild(fieldEl);
        });

        // Добавление нового поля в группу
        if (editMode) {
          const addFieldBtn = document.createElement('button'); addFieldBtn.textContent = '+ Добавить поле';
          addFieldBtn.onclick = () => {
            const newField = { id: `field_${Date.now()}`, placeholder: '', type: 'Текст', options: [], default: '' };
            group.fields.push(newField);
            saveForms();
            renderFormFields();
          };

          groupContent.appendChild(addFieldBtn);
        }

        groupEl.appendChild(groupContent);
        fieldsContainer.appendChild(groupEl);
      });
    }

    // Buttons
    addBtn.onclick = addForm;
    addGroupBtn.onclick = () => { const form = forms[activeIndex]; if (!form.groups) form.groups = []; form.groups.push({ layout: 'row', fields: [] }); saveForms(); renderFormFields(); };

    // Init
    if (forms.length === 0) addForm(); else { renderTabs(); renderFormFields(); }

    generateBtn.onclick = async () => {
      const form = forms[activeIndex]
      if (!form.files || !form.files.length) {
        await showConfirm('Сперва выберите файлы из папки input/ рядом с .exe')
        return
      }

      let allFilled = true;
      form.groups.forEach(group => {
        group.fields.forEach(field => {
          const value = field.type === 'list' ? (field.value || '') : (field.val || '');
          if (!value || value.trim() === '') allFilled = false;
        });
      });

      if (!allFilled) {
        await showConfirm('Заполните все поля перед генерацией!');
        return;
      }

      // 1. Ссылки на input files
      const fileLinks = form.files || []; // массив файлов или пустой

      // 3. Структура {'field id': 'field val'}
      const fieldValues = {};
      form.groups.forEach(group => {
        group.fields.forEach(field => {
          const value = field.type === 'list' ? (field.value || '') : (field.val || '');
          if (field.id) fieldValues[field.id] = value;
        });
      });
      console.log(JSON.stringify(fieldValues))
      const success = await window.docxProcessor.patchFiles(fileLinks, fieldValues)
      if (success) await showConfirm("Файлы успешно сгенерированы!");
      else await showConfirm("Не удалось сгенерировать файлы. Смотри ошибку во вкладке \"Console\" Ctrl+Shift+I");
    };


  </script>
</body>

</html>
